# 配置说明

<cite>
**本文档引用的文件**  
- [config.py](file://config.py)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py)
- [check_ffmpeg.py](file://check_ffmpeg.py)
- [README.md](file://README.md)
</cite>

## 目录
1. [基础配置](#基础配置)  
2. [反反爬配置](#反反爬配置)  
3. [视频下载配置](#视频下载配置)  
4. [FFmpeg路径配置](#ffmpeg路径配置)  
5. [配置调整示例](#配置调整示例)  
6. [安全与最佳实践](#安全与最佳实践)

## 基础配置

本节介绍程序运行所需的基础配置项，包括日志、请求超时、重试机制等，这些配置决定了程序的基本行为和稳定性。

### 日志配置
控制程序运行时的日志输出级别和格式，便于调试和监控。

- **LOG_LEVEL**: 日志级别，类型为 `logging` 常量，默认值 `logging.ERROR`。可选值包括 `DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL`。设置为 `DEBUG` 可输出详细调试信息。
- **LOG_FORMAT**: 日志输出格式字符串，默认值 `'%(asctime)s - %(name)s - %(levelname)s - %(message)s'`。
- **LOG_DATE_FORMAT**: 日志时间格式，默认值 `'%Y-%m-%d %H:%M:%S'`。
- **ENABLE_HTML_DEBUG**: 是否在 `DEBUG` 级别输出HTML内容，布尔值，默认 `True`。
- **HTML_DEBUG_MAX_LENGTH**: HTML调试日志的最大长度，整数，默认 `10000000`。

### 请求与下载配置
控制网络请求的超时和重试行为。

- **DOWNLOAD_TIMEOUT**: 单次下载请求的超时时间（秒），整数，默认 `45`。超时后将尝试重试。
- **MAX_RETRIES**: 下载失败后的最大重试次数，整数，默认 `3`。减少此值可避免因频繁请求被封禁。
- **RETRY_DELAY**: 每次重试之间的基础延迟时间（秒），整数，默认 `10`。增加此值可降低请求频率。
- **RETRY_BACKOFF**: 重试延迟的退避倍数，整数，默认 `3`。实际重试延迟为 `RETRY_DELAY * (RETRY_BACKOFF ** attempt)`，实现指数退避。

### 文件与路径配置
控制文件命名和存储。

- **ALLOWED_IMAGE_FORMATS**: 允许保存的图片格式列表，列表类型，默认 `['.jpg', '.jpeg', '.png', '.webp']`。
- **MAX_FILENAME_LENGTH**: 生成的文件名最大长度，整数，默认 `100`。过长的文件名将被截断。

**Section sources**
- [config.py](file://config.py#L1-L50)

## 反反爬配置

为避免被哔哩哔哩的反爬虫系统检测和封禁，程序实现了多层次的反反爬策略，通过模拟真实用户行为来降低风险。

### 请求间隔配置
控制API请求和页面操作的间隔时间，模拟人类操作的随机性。

- **REQUEST_DELAY_MIN**: API请求的最小间隔时间（秒），浮点数，默认 `3`。
- **REQUEST_DELAY_MAX**: API请求的最大间隔时间（秒），浮点数，默认 `8`。程序会在最小和最大值之间随机选择延迟。
- **DOWNLOAD_DELAY_MIN**: 下载封面图片的最小间隔时间（秒），浮点数，默认 `2`。
- **DOWNLOAD_DELAY_MAX**: 下载封面图片的最大间隔时间（秒），浮点数，默认 `5`。

### 连续请求与休息策略
防止因连续请求过多而触发反爬机制。

- **MAX_CONSECUTIVE_REQUESTS**: 连续请求的最大次数，整数，默认 `30`。达到此次数后，程序将执行长时间休息。
- **LONG_BREAK_DURATION**: 长时间休息的持续时间（秒），整数，默认 `15`。休息后会更新浏览器上下文，模拟用户刷新。
- **ERROR_COOLDOWN**: 出现错误后的冷却时间（秒），整数，默认 `180`。在此期间程序会避免发起新请求。
- **REQUEST_FAILURE_PENALTY**: 单次请求失败后的惩罚时间（秒），整数，默认 `10`。若在惩罚时间内再次请求，将追加等待。
- **FIRST_REQUEST_DELAY**: 首次请求前的额外延迟（秒），整数，默认 `1`。用于模拟用户打开页面后的初始等待。

### Playwright浏览器配置
通过Playwright模拟真实浏览器环境，极大降低被检测的风险。

- **PLAYWRIGHT_CONFIG**: 一个字典，包含Playwright的启动参数。
  - `headless`: 是否以无头模式运行，布尔值，默认 `True`。设为 `False` 可用于调试。
  - `slow_mo`: 每个操作之间的延迟（毫秒），整数，默认 `2000`（2秒）。
  - `timeout`: 页面加载超时时间（毫秒），整数，默认 `120000`（2分钟）。
  - `viewport`: 浏览器视窗大小，字典类型，默认 `{'width': 1920, 'height': 1080}`。
  - `ignore_https_errors`: 是否忽略HTTPS错误，布尔值，默认 `True`。
  - `java_script_enabled`: 是否启用JavaScript，布尔值，默认 `True`。
- **BROWSER_ARGS**: 浏览器启动参数列表，用于隐藏自动化特征，例如 `--disable-blink-features=AutomationControlled`。
- **USER_AGENTS**: User-Agent字符串列表，程序会从中随机选择，模拟不同用户和浏览器访问。
- **BASE_HEADERS_TEMPLATES**: 基础请求头模板列表，根据User-Agent类型选择，包含 `Accept`, `Accept-Language`, `Sec-Fetch-*` 等字段，模拟真实浏览器请求。

**Section sources**
- [config.py](file://config.py#L51-L150)

## 视频下载配置

该配置控制视频文件的下载和处理行为，包括并发、重试和临时文件管理。

### 下载行为配置
- **VIDEO_DOWNLOAD_CONFIG**: 一个字典，包含所有视频下载相关的配置。
  - `enabled`: 是否启用视频下载功能，布尔值，默认 `False`。必须设为 `True` 才能下载视频。
  - `quality`: 下载的视频质量，字符串，可选 `'high'`, `'medium'`, `'low'`，默认 `'high'`。
  - `format`: 输出视频的格式，字符串，默认 `'mp4'`。
  - `max_concurrent`: 最大并发下载数，整数，默认 `2`。降低此值可减少被检测的风险。
  - `segment_timeout`: 分段下载的超时时间（秒），整数，默认 `600`（10分钟）。
  - `retry_times`: 下载失败后的重试次数，整数，默认 `5`。
  - `retry_delay`: 重试延迟的阶段列表（秒），列表类型，默认 `[3, 8, 15]`。每次重试将按此列表顺序增加延迟。
  - `temp_dir`: 存放下载临时文件的目录，字符串，默认 `'temp_videos'`。
  - `output_dir`: 存放最终合并后视频的目录，字符串，默认 `'downloaded_videos'`。

### 反爬虫与请求头配置
- **user_agents**: 视频下载时使用的User-Agent列表，独立于主爬虫的User-Agent。
- **headers_templates**: 视频下载时使用的请求头模板列表，包含通用、视频流和API请求三种模板。
- **anti_crawl**: 一个字典，包含专门针对视频下载的反爬策略。
  - `request_delay_min/max`: 请求间隔。
  - `max_consecutive`: 连续请求限制。
  - `cooldown_time`: 冷却时间。
  - `rotate_headers/user_agent`: 是否轮换请求头和User-Agent。
  - `random_delay`: 是否启用随机延迟。
  - `respect_rate_limit`: 是否遵守速率限制。
- **referers**: Referer列表，随机选择以模拟真实来源。

**Section sources**
- [config.py](file://config.py#L259-L300)

## FFmpeg路径配置

FFmpeg用于合并下载的音视频分段。此配置负责查找和调用FFmpeg可执行文件。

### FFmpeg功能配置
- **FFMPEG_CONFIG**: 一个字典，控制FFmpeg的使用。
  - `enabled`: 是否启用FFmpeg功能，布尔值，默认 `True`。设为 `False` 将跳过合并步骤。
  - `custom_path`: 自定义的FFmpeg可执行文件路径，字符串，默认 `''`。此路径优先级最高。
  - `timeout`: FFmpeg执行的超时时间（秒），整数，默认 `300`（5分钟）。
  - `quality_preset`: 编码预设，字符串，可选 `'ultrafast'`, `'superfast'`, ..., `'veryslow'`，默认 `'fast'`。
  - `video_codec`: 视频编解码器，字符串，可选 `'copy'`（不重编码）, `'libx264'` 等，默认 `'copy'`。
  - `audio_codec`: 音频编解码器，字符串，可选 `'aac'`, `'mp3'`, `'copy'` 等，默认 `'aac'`。
  - `extra_args`: 额外的FFmpeg命令行参数列表，列表类型，默认 `['-strict', 'experimental']`。

### 跨平台路径搜索
- **search_paths**: 一个嵌套字典，定义了在不同操作系统下搜索FFmpeg的路径顺序。
  - `windows`: 包含 `.exe` 文件的路径，如 `./bin/ffmpeg.exe`, `C:\ffmpeg\bin\ffmpeg.exe`。
  - `linux`: 包含 `ffmpeg` 的路径，如 `/usr/bin/ffmpeg`, `/usr/local/bin/ffmpeg`。
  - `darwin`: macOS下的路径，如 `/usr/local/bin/ffmpeg`, `/opt/homebrew/bin/ffmpeg` (Apple Silicon)。

**Section sources**
- [config.py](file://config.py#L301-L399)
- [check_ffmpeg.py](file://check_ffmpeg.py#L0-L176)

## 配置调整示例

### 根据网络环境调整延迟参数
当您的网络环境较差或IP被频繁限制时，应大幅增加延迟参数以避免被封禁。

```python
# config.py
# 在网络不稳定或被限制时，使用更保守的策略
REQUEST_DELAY_MIN = 10  # 增加到10秒
REQUEST_DELAY_MAX = 20  # 增加到20秒
DOWNLOAD_DELAY_MIN = 5  # 增加到5秒
DOWNLOAD_DELAY_MAX = 10 # 增加到10秒
MAX_CONSECUTIVE_REQUESTS = 10  # 更频繁地休息
LONG_BREAK_DURATION = 60  # 休息1分钟
```

### 自定义FFmpeg路径
如果您将FFmpeg安装在非标准位置，可以通过 `custom_path` 指定其路径。

```python
# config.py
# Windows示例
FFMPEG_CONFIG = {
    'custom_path': 'D:\\tools\\ffmpeg\\bin\\ffmpeg.exe',
    'enabled': True
}

# Linux/macOS示例
FFMPEG_CONFIG = {
    'custom_path': '/home/user/my_ffmpeg/ffmpeg',
    'enabled': True
}
```

**Section sources**
- [config.py](file://config.py#L200-L250)
- [README.md](file://README.md#L301-L336)

## 安全与最佳实践

### 配置文件的集中管理优势
将所有可配置项集中于 `config.py` 文件，具有以下优势：
- **无需修改代码**：用户可以通过修改配置文件来自定义程序行为，而无需触碰主程序代码，降低了出错风险。
- **易于维护和分享**：可以轻松地备份、分享或在不同环境中复用配置。
- **快速迭代**：可以快速调整策略（如延迟、重试）进行测试，无需重新部署代码。

### 关键安全配置建议
- **避免激进的请求频率**：切勿将 `REQUEST_DELAY_MIN` 设置为小于 `1` 秒，或将 `MAX_CONSECUTIVE_REQUESTS` 设置得过高。这极易导致IP被永久封禁。
- **合理设置重试**：`MAX_RETRIES` 和 `RETRY_DELAY` 应配合使用。过高的重试次数和过短的延迟会加剧反爬风险。
- **启用HTML调试时注意隐私**：`ENABLE_HTML_DEBUG` 在 `DEBUG` 模式下会输出大量HTML内容，可能包含敏感信息，请谨慎使用。
- **验证FFmpeg安装**：在启用视频下载前，运行 `python check_ffmpeg.py` 验证FFmpeg是否正确安装和配置。

**Section sources**
- [config.py](file://config.py#L0-L399)
- [README.md](file://README.md#L226-L336)
- [EMERGENCY_GUIDE.md](file://EMERGENCY_GUIDE.md#L0-L60)