# 基础配置

<cite>
**本文档中引用的文件**  
- [config.py](file://config.py)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py)
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心配置项详解](#核心配置项详解)
3. [配置项对程序行为的影响](#配置项对程序行为的影响)
4. [配置修改示例](#配置修改示例)
5. [错误配置可能导致的问题](#错误配置可能导致的问题)
6. [最佳实践建议](#最佳实践建议)

## 简介
本项目为哔哩哔哩用户视频封面爬虫，采用Playwright技术模拟真实浏览器行为以降低被反爬虫机制拦截的风险。`config.py` 文件是整个项目的核心配置文件，定义了日志级别、文件命名规则、请求延迟、浏览器行为等关键参数。本文档将详细说明其中的基础配置项，帮助用户理解其作用、合理调整配置以满足调试和运行需求。

## 核心配置项详解

### 日志级别 (LOG_LEVEL)
**数据类型**: 整数（通过 `logging` 模块定义的常量）  
**默认值**: `logging.ERROR`  
**作用范围**: 全局日志系统  

`LOG_LEVEL` 决定了程序运行时输出日志的详细程度。它控制 `logging` 模块记录哪些级别的日志信息。可选值包括：
- `DEBUG`: 输出最详细的调试信息，包括所有请求、响应和内部状态。
- `INFO`: 输出一般性信息，如程序启动、关键步骤完成。
- `WARNING`: 输出潜在问题的警告。
- `ERROR`: 仅输出错误信息。
- `CRITICAL`: 仅输出严重错误。

此配置影响 `bilibili_cover_crawler_playwright.py` 和 `bilibili_cover_crawler.py` 中的 `logging.basicConfig()` 调用，是程序调试和监控的关键。

### 最大文件名长度 (MAX_FILENAME_LENGTH)
**数据类型**: 整数  
**默认值**: `100`  
**作用范围**: 文件系统操作  

`MAX_FILENAME_LENGTH` 限制了保存封面图片时生成的文件名的最大字符数。当视频标题过长时，程序会截取前100个字符作为文件名的一部分，以防止因文件名过长而导致的文件系统错误（尤其是在Windows系统上）。

此配置被 `bilibili_cover_crawler.py` 和 `bilibili_cover_crawler_playwright.py` 中的 `sanitize_filename` 方法引用，用于清理和截断文件名。

### 允许的图片格式 (ALLOWED_IMAGE_FORMATS)
**数据类型**: 字符串列表  
**默认值**: `['.jpg', '.jpeg', '.png', '.webp']`  
**作用范围**: 图片下载与处理  

`ALLOWED_IMAGE_FORMATS` 定义了程序在处理图片URL时，认为是有效图片的文件扩展名。程序会根据此列表来确定下载图片的默认扩展名。如果从URL中无法解析出有效扩展名，则会使用默认的 `.jpg`。

此配置被 `bilibili_cover_crawler.py` 中的 `get_image_extension` 方法使用。

### 下载超时 (DOWNLOAD_TIMEOUT)
**数据类型**: 整数  
**默认值**: `45`  
**作用范围**: 网络请求  

`DOWNLOAD_TIMEOUT` 设置了单次HTTP请求的超时时间（秒）。如果在45秒内未能完成请求（如下载封面图片），则请求将被中断并可能触发重试机制。

此配置在 `bilibili_cover_crawler.py` 的 `download_cover` 方法和 `bilibili_cover_crawler_playwright.py` 的 `init_session` 方法中被使用。

### 最大重试次数 (MAX_RETRIES)
**数据类型**: 整数  
**默认值**: `3`  
**作用范围**: 网络请求错误处理  

`MAX_RETRIES` 定义了当网络请求失败（如超时、服务器错误）时，程序自动重试的最大次数。结合 `RETRY_DELAY` 和 `RETRY_BACKOFF`，形成一个指数退避重试策略，以应对临时性的网络问题。

此配置在 `bilibili_cover_crawler.py` 的 `get_user_info`, `get_user_videos`, `download_cover` 等方法中被使用。

**Section sources**
- [config.py](file://config.py#L8-L129)

## 配置项对程序行为的影响

### 日志级别对调试的影响
日志级别直接决定了程序的“透明度”。在正常运行时，使用 `ERROR` 级别可以保持输出简洁。但在调试阶段，将 `LOG_LEVEL` 修改为 `DEBUG` 可以提供极其丰富的信息：
- 可以看到每次请求的URL、请求头和响应状态码。
- 可以追踪到 `Playwright` 浏览器的每一步操作，如页面跳转、元素等待。
- 可以了解反爬虫策略的触发情况，如请求延迟的计算和浏览器上下文的更新。

例如，在 `bilibili_cover_crawler_playwright.py` 中，`logger.debug()` 语句只有在 `LOG_LEVEL` 设为 `DEBUG` 或更低级别时才会输出。

### 文件名长度限制对文件保存的影响
`MAX_FILENAME_LENGTH` 是一个重要的安全边界。它防止了以下问题：
1.  **文件系统兼容性问题**：某些文件系统（如FAT32）对文件名长度有严格限制（通常为255字符，但路径总长度也有限制）。过长的文件名可能导致 `OSError`。
2.  **路径过长问题**：即使文件名本身不长，但加上用户ID、用户名和目录路径后，总路径长度可能超过操作系统的限制（Windows为260字符）。限制文件名长度是缓解此问题的第一道防线。
3.  **用户体验**：过长的文件名在文件管理器中难以阅读和管理。

当程序调用 `sanitize_filename` 方法时，会检查文件名长度并进行截断，确保最终的文件名符合此限制。

**Section sources**
- [config.py](file://config.py#L8-L129)
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L161-L162)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L743-L744)

## 配置修改示例

### 示例1：修改日志级别以辅助调试
为了诊断程序在获取用户信息时失败的原因，可以将日志级别调整为 `DEBUG`。

```python
# 在 config.py 文件中修改
LOG_LEVEL = logging.DEBUG  # 将 ERROR 改为 DEBUG
```

修改后，重新运行程序。您将看到类似如下的详细日志输出：
```
2023-10-27 10:00:01 - __main__ - DEBUG - 使用User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 ...
2023-10-27 10:00:02 - __main__ - DEBUG - 请求用户信息: UID=123456, URL=https://api.bilibili.com/x/space/acc/info
2023-10-27 10:00:03 - __main__ - DEBUG - HTTP请求失败: 状态码: 429
2023-10-27 10:00:03 - __main__ - WARNING - 检测到反爬措施: Too Many Requests
```
这些日志清晰地表明，问题出在请求过于频繁而被服务器拒绝（429状态码），从而可以针对性地调整 `REQUEST_DELAY_MIN` 和 `REQUEST_DELAY_MAX`。

### 示例2：调整下载目录
虽然 `config.py` 中没有直接的“下载路径”配置项，但下载目录是在主程序中根据用户信息动态生成的。例如，在 `bilibili_cover_crawler.py` 的 `crawl_user_covers` 方法中：
```python
save_dir = Path(f"{uid}_{safe_user_name}")
```
要修改下载目录，可以在该行代码前添加逻辑，例如将所有下载保存到一个固定的 `downloads` 文件夹中：
```python
base_dir = Path("downloads")
save_dir = base_dir / f"{uid}_{safe_user_name}"
```
这会将所有用户的封面保存在 `downloads/` 目录下的子文件夹中。

**Section sources**
- [config.py](file://config.py#L8)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L26)
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L308-L309)

## 错误配置可能导致的问题

### 1. 日志级别设置过低
- **问题**: 将 `LOG_LEVEL` 设置为 `CRITICAL` 或 `ERROR` 会隐藏大量的警告和调试信息。
- **后果**: 当程序出现非致命性问题（如单个请求失败）时，用户无法得知，可能导致最终下载结果不完整，但用户却不知原因。
- **解决方案**: 在生产环境中使用 `ERROR`，在调试和首次运行时务必使用 `INFO` 或 `DEBUG`。

### 2. 文件名长度限制设置过长
- **问题**: 将 `MAX_FILENAME_LENGTH` 设置为一个非常大的值，如 `300`。
- **后果**: 在Windows系统上，如果用户ID、用户名和长视频标题组合起来，很容易超过260字符的路径限制，导致 `OSError: [Errno 36] File name too long`，所有后续文件都无法保存。
- **解决方案**: 保持默认值 `100` 或根据实际需求谨慎增加，但需考虑最坏情况下的总路径长度。

### 3. 下载超时设置过短
- **问题**: 将 `DOWNLOAD_TIMEOUT` 设置为 `5` 秒。
- **后果**: 在网络状况不佳时，大部分图片下载请求都会因为超时而失败。尽管有重试机制，但频繁的失败和重试会显著降低效率，并可能触发反爬虫机制。
- **解决方案**: 保持 `45` 秒的默认值，或根据网络环境适当调整，但不应低于 `20` 秒。

**Section sources**
- [config.py](file://config.py#L8-L129)

## 最佳实践建议

1.  **调试阶段开启DEBUG日志**: 在首次使用或遇到问题时，务必在 `config.py` 中将 `LOG_LEVEL` 设置为 `logging.DEBUG`。这能提供最全面的诊断信息。
2.  **保持文件名长度限制**: 不要随意增加 `MAX_FILENAME_LENGTH`。100个字符对于视频标题来说已经非常充裕，过长的文件名并无实际意义且风险高。
3.  **理解重试机制**: `MAX_RETRIES`, `RETRY_DELAY`, `RETRY_BACKOFF` 共同构成了一个稳健的错误恢复策略。不要将 `MAX_RETRIES` 设为0，也不要将 `RETRY_DELAY` 设得过短，以免在失败时对服务器造成过大压力。
4.  **尊重反爬虫配置**: `REQUEST_DELAY_MIN`, `REQUEST_DELAY_MAX`, `MAX_CONSECUTIVE_REQUESTS` 等参数是为了模拟人类用户行为。在非必要情况下，不要为了追求速度而大幅降低这些值，这可能导致IP被封禁。
5.  **备份配置文件**: 在对 `config.py` 进行重大修改前，建议先备份原文件，以便在出现问题时可以快速恢复。