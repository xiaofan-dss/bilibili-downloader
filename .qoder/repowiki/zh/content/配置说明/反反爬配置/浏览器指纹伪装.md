# æµè§ˆå™¨æŒ‡çº¹ä¼ªè£…

<cite>
**Referenced Files in This Document**   
- [config.py](file://config.py)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py)
</cite>

## ç›®å½•
1. [æµè§ˆå™¨æŒ‡çº¹ä¼ªè£…é…ç½®æ€»è§ˆ](#æµè§ˆå™¨æŒ‡çº¹ä¼ªè£…é…ç½®æ€»è§ˆ)
2. [Playwrightæ ¸å¿ƒé…ç½®è§£æ](#playwrightæ ¸å¿ƒé…ç½®è§£æ)
3. [æµè§ˆå™¨å¯åŠ¨å‚æ•°è¯¦è§£](#æµè§ˆå™¨å¯åŠ¨å‚æ•°è¯¦è§£)
4. [åæ£€æµ‹è„šæœ¬æ³¨å…¥æœºåˆ¶](#åæ£€æµ‹è„šæœ¬æ³¨å…¥æœºåˆ¶)
5. [æµè§ˆå™¨åˆå§‹åŒ–æµç¨‹](#æµè§ˆå™¨åˆå§‹åŒ–æµç¨‹)
6. [ç»¼åˆä¼ªè£…ç­–ç•¥](#ç»¼åˆä¼ªè£…ç­–ç•¥)

## æµè§ˆå™¨æŒ‡çº¹ä¼ªè£…é…ç½®æ€»è§ˆ

æœ¬é¡¹ç›®é€šè¿‡å¤šå±‚æ¬¡çš„é…ç½®å’Œä»£ç å®ç°ï¼Œæ„å»ºäº†ä¸€ä¸ªé«˜åº¦ä»¿çœŸçš„æµè§ˆå™¨ç¯å¢ƒï¼Œæœ‰æ•ˆéšè—äº†è‡ªåŠ¨åŒ–å·¥å…·çš„ç‰¹å¾ã€‚ç³»ç»Ÿä¸»è¦é€šè¿‡ä¸‰ä¸ªå±‚é¢å®ç°æµè§ˆå™¨æŒ‡çº¹ä¼ªè£…ï¼š

1. **Playwrightè¿è¡Œæ—¶é…ç½®**ï¼šé€šè¿‡`PLAYWRIGHT_CONFIG`å­—å…¸å®šä¹‰äº†æµè§ˆå™¨çš„åŸºæœ¬è¡Œä¸ºç‰¹å¾
2. **æµè§ˆå™¨å¯åŠ¨å‚æ•°**ï¼šé€šè¿‡`BROWSER_ARGS`åˆ—è¡¨ä¼ é€’åº•å±‚Chromiumå‚æ•°
3. **JavaScriptåæ£€æµ‹è„šæœ¬**ï¼šé€šè¿‡`add_stealth_scripts()`æ–¹æ³•æ³¨å…¥è„šæœ¬ï¼Œä¿®æ”¹æµè§ˆå™¨çš„JavaScriptå±æ€§

è¿™äº›é…ç½®å…±åŒä½œç”¨ï¼Œä½¿å¾—è‡ªåŠ¨åŒ–çˆ¬è™«èƒ½å¤Ÿæ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„è¡Œä¸ºå’Œç¯å¢ƒï¼Œä»è€Œç»•è¿‡å“”å“©å“”å“©ç­‰ç½‘ç«™çš„åçˆ¬è™«æ£€æµ‹æœºåˆ¶ã€‚

**Section sources**
- [config.py](file://config.py#L26-L36)
- [config.py](file://config.py#L37-L55)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L581-L614)

## Playwrightæ ¸å¿ƒé…ç½®è§£æ

`PLAYWRIGHT_CONFIG`é…ç½®å­—å…¸å®šä¹‰äº†Playwrightæµè§ˆå™¨çš„æ ¸å¿ƒè¡Œä¸ºç‰¹å¾ï¼Œè¿™äº›é…ç½®ç›´æ¥å½±å“æµè§ˆå™¨çš„å¤–è§‚å’Œè¡Œä¸ºæ¨¡å¼ã€‚

```mermaid
classDiagram
class PLAYWRIGHT_CONFIG {
+bool headless
+int slow_mo
+int timeout
+dict viewport
+str user_agent
+bool ignore_https_errors
+bool java_script_enabled
}
class BrowserContext {
+dict viewport
+str user_agent
+bool java_script_enabled
+bool ignore_https_errors
}
PLAYWRIGHT_CONFIG --> BrowserContext : "é…ç½®"
```

**Diagram sources**
- [config.py](file://config.py#L26-L36)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L526-L540)

### headlessé…ç½®

`headless`é…ç½®é¡¹æ§åˆ¶æµè§ˆå™¨æ˜¯å¦ä»¥æ— å¤´æ¨¡å¼è¿è¡Œã€‚åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œè¯¥å€¼è¢«è®¾ç½®ä¸º`True`ï¼Œä½†æ³¨é‡Šä¸­æ˜ç¡®æŒ‡å‡º"æ”¹ä¸ºéæ— å¤´æ¨¡å¼ï¼Œä¾¿äºè°ƒè¯•"ã€‚

- **ä½œç”¨**ï¼šå½“è®¾ç½®ä¸º`False`æ—¶ï¼Œæµè§ˆå™¨ä¼šæ˜¾ç¤ºå›¾å½¢ç•Œé¢ï¼Œä¾¿äºå¼€å‘è€…è§‚å¯Ÿå’Œè°ƒè¯•çˆ¬è™«è¡Œä¸º
- **ä¼ªè£…æ„ä¹‰**ï¼šè™½ç„¶æ— å¤´æ¨¡å¼æœ¬èº«ä¸ä¼šè¢«ç›´æ¥æ£€æµ‹ï¼Œä½†ç»“åˆå…¶ä»–é…ç½®å¯ä»¥æ›´å¥½åœ°æ¨¡æ‹ŸçœŸå®ç”¨æˆ·ç¯å¢ƒ
- **è°ƒè¯•ä»·å€¼**ï¼šåœ¨å¼€å‘å’Œè°ƒè¯•é˜¶æ®µï¼Œéæ— å¤´æ¨¡å¼å¯ä»¥å¸®åŠ©å¼€å‘è€…ç›´è§‚åœ°çœ‹åˆ°é¡µé¢åŠ è½½å’Œäº¤äº’è¿‡ç¨‹

### slow_moé…ç½®

`slow_mo`é…ç½®é¡¹è®¾ç½®äº†æ“ä½œä¹‹é—´çš„å»¶è¿Ÿï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚

- **å½“å‰å€¼**ï¼š2000æ¯«ç§’ï¼ˆ2ç§’ï¼‰
- **ä½œç”¨**ï¼šåœ¨æ¯ä¸ªæµè§ˆå™¨æ“ä½œï¼ˆå¦‚ç‚¹å‡»ã€è¾“å…¥ã€å¯¼èˆªï¼‰ä¹‹é—´æ·»åŠ å»¶è¿Ÿ
- **ä¼ªè£…æ„ä¹‰**ï¼šæ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„æ“ä½œèŠ‚å¥ï¼Œé¿å…è¿‡å¿«çš„æ“ä½œè¢«è¯†åˆ«ä¸ºè‡ªåŠ¨åŒ–è¡Œä¸º
- **ä¼˜åŒ–ç­–ç•¥**ï¼š2ç§’çš„å»¶è¿Ÿè¶³å¤Ÿé•¿ï¼Œå¯ä»¥æœ‰æ•ˆé™ä½è¢«æ£€æµ‹çš„é£é™©ï¼ŒåŒæ—¶ä¸ä¼šæ˜¾è‘—å½±å“çˆ¬å–æ•ˆç‡

### viewporté…ç½®

`viewport`é…ç½®é¡¹å®šä¹‰äº†æµè§ˆå™¨çª—å£çš„è§†å£å¤§å°ã€‚

- **å½“å‰å€¼**ï¼šå®½åº¦1920åƒç´ ï¼Œé«˜åº¦1080åƒç´ 
- **ä½œç”¨**ï¼šè®¾ç½®æµè§ˆå™¨çª—å£çš„å°ºå¯¸
- **ä¼ªè£…æ„ä¹‰**ï¼š1920x1080æ˜¯å½“å‰æœ€ä¸»æµçš„æ¡Œé¢æ˜¾ç¤ºå™¨åˆ†è¾¨ç‡ï¼Œä½¿ç”¨è¯¥å°ºå¯¸å¯ä»¥æ¨¡æ‹Ÿå¤§å¤šæ•°çœŸå®ç”¨æˆ·çš„è®¾å¤‡ç¯å¢ƒ
- **å…¼å®¹æ€§**ï¼šè¯¥åˆ†è¾¨ç‡èƒ½å¤Ÿå®Œæ•´æ˜¾ç¤ºå¤§å¤šæ•°ç½‘é¡µå†…å®¹ï¼Œé¿å…å› çª—å£è¿‡å°å¯¼è‡´çš„å¸ƒå±€é—®é¢˜

**Section sources**
- [config.py](file://config.py#L26-L36)

## æµè§ˆå™¨å¯åŠ¨å‚æ•°è¯¦è§£

`BROWSER_ARGS`åˆ—è¡¨åŒ…å«äº†ä¼ é€’ç»™Chromiumæµè§ˆå™¨çš„å¯åŠ¨å‚æ•°ï¼Œè¿™äº›å‚æ•°åœ¨æµè§ˆå™¨è¿›ç¨‹å¯åŠ¨æ—¶ç”Ÿæ•ˆï¼Œèƒ½å¤Ÿæ·±å…¥ä¿®æ”¹æµè§ˆå™¨çš„è¡Œä¸ºå’Œç‰¹å¾ã€‚

```mermaid
flowchart TD
Start([æµè§ˆå™¨å¯åŠ¨]) --> Sandbox["--no-sandbox<br/>--disable-setuid-sandbox"]
Sandbox --> Memory["--disable-dev-shm-usage"]
Memory --> Throttling["--disable-background-timer-throttling<br/>--disable-backgrounding-occluded-windows<br/>--disable-renderer-backgrounding"]
Throttling --> Features["--disable-features=TranslateUI<br/>--disable-extensions"]
Features --> Automation["--disable-blink-features=AutomationControlled"]
Automation --> Security["--disable-web-security<br/>--allow-running-insecure-content"]
Security --> Viz["--disable-features=VizDisplayCompositor"]
Viz --> End([æµè§ˆå™¨å‡†å¤‡å°±ç»ª])
```

**Diagram sources**
- [config.py](file://config.py#L37-L55)

### æ²™ç®±ä¸å†…å­˜ç®¡ç†å‚æ•°

```python
'--no-sandbox',
'--disable-setuid-sandbox', 
'--disable-dev-shm-usage'
```

- **`--no-sandbox`**ï¼šç¦ç”¨æ²™ç®±æ¨¡å¼ã€‚åœ¨æŸäº›æœåŠ¡å™¨ç¯å¢ƒä¸­ï¼Œæ²™ç®±å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼Œç¦ç”¨å®ƒå¯ä»¥ç¡®ä¿æµè§ˆå™¨ç¨³å®šè¿è¡Œ
- **`--disable-setuid-sandbox`**ï¼šç¦ç”¨setuidæ²™ç®±ï¼Œè¿›ä¸€æ­¥é™ä½æƒé™é™åˆ¶
- **`--disable-dev-shm-usage`**ï¼šç¦ç”¨/dev/shmçš„ä½¿ç”¨ï¼Œæ”¹ä¸ºä½¿ç”¨ç£ç›˜ä¸´æ—¶æ–‡ä»¶ï¼Œé¿å…åœ¨Dockerç­‰å®¹å™¨ç¯å¢ƒä¸­å› å…±äº«å†…å­˜ä¸è¶³å¯¼è‡´çš„é—®é¢˜

### èƒŒæ™¯æ´»åŠ¨æ§åˆ¶å‚æ•°

```python
'--disable-background-timer-throttling',
'--disable-backgrounding-occluded-windows',
'--disable-renderer-backgrounding'
```

- è¿™äº›å‚æ•°å…±åŒä½œç”¨ï¼Œé˜²æ­¢æµè§ˆå™¨åœ¨åå°è¿è¡Œæ—¶é™ä½æ€§èƒ½æˆ–é™åˆ¶JavaScriptå®šæ—¶å™¨çš„æ‰§è¡Œ
- **ä¼ªè£…æ„ä¹‰**ï¼šç¡®ä¿å³ä½¿åœ¨è‡ªåŠ¨åŒ–ç¯å¢ƒä¸­ï¼Œæµè§ˆå™¨ä¹Ÿèƒ½ä¿æŒä¸å‰å°è¿è¡Œæ—¶ç›¸åŒçš„æ€§èƒ½è¡¨ç°ï¼Œé¿å…å› æ€§èƒ½å·®å¼‚è¢«æ£€æµ‹

### åŠŸèƒ½ç¦ç”¨å‚æ•°

```python
'--disable-features=TranslateUI',
'--disable-extensions',
'--no-first-run',
'--no-default-browser-check',
'--disable-default-apps'
```

- **`--disable-features=TranslateUI`**ï¼šç¦ç”¨ç¿»è¯‘ç•Œé¢ï¼Œé¿å…å‡ºç°ç¿»è¯‘æç¤º
- **`--disable-extensions`**ï¼šç¦ç”¨æ‰€æœ‰æ‰©å±•ç¨‹åºï¼Œä¿æŒæµè§ˆå™¨çš„çº¯å‡€çŠ¶æ€
- **`--no-first-run`**ï¼šè·³è¿‡é¦–æ¬¡è¿è¡Œçš„è®¾ç½®å‘å¯¼
- **`--no-default-browser-check`**ï¼šä¸æ£€æŸ¥æ˜¯å¦ä¸ºé»˜è®¤æµè§ˆå™¨
- **`--disable-default-apps`**ï¼šç¦ç”¨é»˜è®¤å®‰è£…çš„åº”ç”¨ç¨‹åº

### è‡ªåŠ¨åŒ–æ ‡è¯†éšè—å‚æ•°

```python
'--disable-blink-features=AutomationControlled'
```

- **æ ¸å¿ƒä½œç”¨**ï¼šè¿™æ˜¯æœ€é‡è¦çš„åæ£€æµ‹å‚æ•°ä¹‹ä¸€ï¼Œå®ƒéšè—äº†æµè§ˆå™¨çš„è‡ªåŠ¨åŒ–æ§åˆ¶æ ‡è¯†
- **æŠ€æœ¯åŸç†**ï¼šç°ä»£æµè§ˆå™¨ï¼ˆå¦‚Chromiumï¼‰ä¼šé€šè¿‡`navigator.webdriver`å±æ€§æš´éœ²æ˜¯å¦è¢«è‡ªåŠ¨åŒ–å·¥å…·æ§åˆ¶ã€‚æ­¤å‚æ•°è¯•å›¾éšè—è¿™ä¸€ç‰¹å¾
- **å±€é™æ€§**ï¼šä»…é æ­¤å‚æ•°ä¸è¶³ä»¥å®Œå…¨éšè—è‡ªåŠ¨åŒ–ç‰¹å¾ï¼Œéœ€è¦é…åˆJavaScriptè„šæœ¬è¿›ä¸€æ­¥ä¿®æ”¹

### å®‰å…¨ç­–ç•¥å‚æ•°

```python
'--disable-web-security', 
'--allow-running-insecure-content'
```

- **`--disable-web-security`**ï¼šç¦ç”¨åŒæºç­–ç•¥ç­‰Webå®‰å…¨é™åˆ¶
- **`--allow-running-insecure-content`**ï¼šå…è®¸åœ¨HTTPSé¡µé¢ä¸Šè¿è¡ŒHTTPå†…å®¹
- **é£é™©ä¸æ”¶ç›Š**ï¼šè™½ç„¶é™ä½äº†å®‰å…¨æ€§ï¼Œä½†æé«˜äº†çˆ¬è™«çš„å…¼å®¹æ€§ï¼Œèƒ½å¤Ÿè®¿é—®æ›´å¤šç±»å‹çš„é¡µé¢å†…å®¹

### æ˜¾ç¤ºåˆæˆå™¨å‚æ•°

```python
'--disable-features=VizDisplayCompositor'
```

- ç¦ç”¨æ˜¾ç¤ºåˆæˆå™¨åŠŸèƒ½ï¼Œå¯èƒ½ä¸é¡µé¢æ¸²æŸ“æ€§èƒ½å’Œç‰¹å¾æœ‰å…³
- æœ‰åŠ©äºå‡å°‘æµè§ˆå™¨çš„ç‰¹å¾æŒ‡çº¹ï¼Œä½¿å…¶æ›´æ¥è¿‘æ™®é€šç”¨æˆ·çš„é…ç½®

**Section sources**
- [config.py](file://config.py#L37-L55)

## åæ£€æµ‹è„šæœ¬æ³¨å…¥æœºåˆ¶

`add_stealth_scripts()`æ–¹æ³•é€šè¿‡`page.add_init_script()`æ³¨å…¥JavaScriptä»£ç ï¼Œç›´æ¥ä¿®æ”¹æµè§ˆå™¨çš„JavaScriptç¯å¢ƒï¼Œéšè—è‡ªåŠ¨åŒ–ç‰¹å¾ã€‚

```mermaid
sequenceDiagram
participant Crawler as PlaywrightBilibiliCrawler
participant Page as Browser Page
participant JS as JavaScript Environment
Crawler->>Page : add_init_script()
Page->>JS : æ³¨å…¥è„šæœ¬1
JS-->>Page : éšè—webdriverå±æ€§
Page->>JS : æ³¨å…¥è„šæœ¬2
JS-->>Page : æ¨¡æ‹Ÿchromeå¯¹è±¡
Page->>JS : æ³¨å…¥è„šæœ¬3
JS-->>Page : æ¨¡æ‹Ÿæ’ä»¶åˆ—è¡¨
Page->>JS : æ³¨å…¥è„šæœ¬4
JS-->>Page : æ¨¡æ‹Ÿè¯­è¨€åå¥½
Page-->>Crawler : åˆå§‹åŒ–å®Œæˆ
```

**Diagram sources**
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L581-L614)

### éšè—webdriverå±æ€§

```javascript
Object.defineProperty(navigator, 'webdriver', {
    get: () => undefined,
});
```

- **æ£€æµ‹ç›®æ ‡**ï¼šè®¸å¤šç½‘ç«™é€šè¿‡æ£€æŸ¥`navigator.webdriver`å±æ€§æ¥è¯†åˆ«è‡ªåŠ¨åŒ–æµè§ˆå™¨
- **è§£å†³æ–¹æ¡ˆ**ï¼šé‡æ–°å®šä¹‰è¯¥å±æ€§çš„getteræ–¹æ³•ï¼Œä½¿å…¶è¿”å›`undefined`
- **æ•ˆæœ**ï¼šå½“ç½‘ç«™å°è¯•è¯»å–`navigator.webdriver`æ—¶ï¼Œå°†å¾—åˆ°`undefined`è€Œä¸æ˜¯`true`ï¼Œä»è€Œç»•è¿‡æ£€æµ‹

### æ¨¡æ‹Ÿchromeå¯¹è±¡

```javascript
window.chrome = {
    runtime: {},
    loadTimes: function() {},
    csi: function() {},
    app: {}
};
```

- **æ£€æµ‹ç›®æ ‡**ï¼šçœŸå®Chromeæµè§ˆå™¨å­˜åœ¨`window.chrome`å¯¹è±¡ï¼Œè€Œæ— å¤´æµè§ˆå™¨å¯èƒ½ç¼ºå°‘è¯¥å¯¹è±¡æˆ–å…¶å±æ€§
- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„`chrome`å¯¹è±¡ï¼ŒåŒ…å«å¸¸è§çš„å±æ€§å’Œæ–¹æ³•
- **æ•ˆæœ**ï¼šä½¿è‡ªåŠ¨åŒ–æµè§ˆå™¨çš„JavaScriptç¯å¢ƒæ›´æ¥è¿‘çœŸå®Chromeæµè§ˆå™¨

### æ¨¡æ‹Ÿæ’ä»¶åˆ—è¡¨

```javascript
Object.defineProperty(navigator, 'plugins', {
    get: () => [1, 2, 3, 4, 5],
});
```

- **æ£€æµ‹ç›®æ ‡**ï¼šé€šè¿‡`navigator.plugins`è·å–æµè§ˆå™¨å®‰è£…çš„æ’ä»¶åˆ—è¡¨ï¼Œå¼‚å¸¸çš„æ’ä»¶åˆ—è¡¨å¯èƒ½æš´éœ²è‡ªåŠ¨åŒ–ç¯å¢ƒ
- **è§£å†³æ–¹æ¡ˆ**ï¼šé‡æ–°å®šä¹‰`plugins`å±æ€§çš„getterï¼Œè¿”å›ä¸€ä¸ªå›ºå®šé•¿åº¦çš„æ•°ç»„
- **æ•ˆæœ**ï¼šé¿å…è¿”å›ç©ºæ•°ç»„æˆ–å¼‚å¸¸çš„æ’ä»¶ä¿¡æ¯ï¼Œæ¨¡æ‹ŸçœŸå®æµè§ˆå™¨çš„æ’ä»¶ç¯å¢ƒ

### æ¨¡æ‹Ÿè¯­è¨€åå¥½

```javascript
Object.defineProperty(navigator, 'languages', {
    get: () => ['zh-CN', 'zh', 'en'],
});
```

- **æ£€æµ‹ç›®æ ‡**ï¼š`navigator.languages`åæ˜ ç”¨æˆ·çš„è¯­è¨€åå¥½è®¾ç½®
- **è§£å†³æ–¹æ¡ˆ**ï¼šé‡æ–°å®šä¹‰è¯¥å±æ€§ï¼Œè¿”å›å¸¸è§çš„ä¸­æ–‡å’Œè‹±æ–‡è¯­è¨€åå¥½
- **æ•ˆæœ**ï¼šæ¨¡æ‹Ÿä¸­å›½åœ°åŒºç”¨æˆ·çš„è¯­è¨€è®¾ç½®ï¼Œå¢å¼ºç¯å¢ƒçš„çœŸå®æ€§

**Section sources**
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L581-L614)

## æµè§ˆå™¨åˆå§‹åŒ–æµç¨‹

`initialize_browser()`æ–¹æ³•æ•´åˆäº†æ‰€æœ‰é…ç½®ï¼Œåˆ›å»ºäº†ä¸€ä¸ªé«˜åº¦ä»¿çœŸçš„æµè§ˆå™¨ç¯å¢ƒã€‚

```mermaid
flowchart TD
Start([å¼€å§‹åˆå§‹åŒ–]) --> Launch["å¯åŠ¨æµè§ˆå™¨<br/>headless, slow_mo, args"]
Launch --> Context["åˆ›å»ºæµè§ˆå™¨ä¸Šä¸‹æ–‡<br/>viewport, user_agent, features"]
Context --> Headers["è®¾ç½®è¯·æ±‚å¤´<br/>Accept-Language, sec-ch-uaç­‰"]
Headers --> Page["åˆ›å»ºé¡µé¢<br/>è®¾ç½®è¶…æ—¶"]
Page --> Scripts["æ³¨å…¥åæ£€æµ‹è„šæœ¬<br/>add_stealth_scripts()"]
Scripts --> Warmup["é¢„çƒ­å»¶è¿Ÿ<br/>INITIAL_WARMUP_DELAY"]
Warmup --> End([åˆå§‹åŒ–å®Œæˆ])
```

**Diagram sources**
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L517-L579)

### æµè§ˆå™¨å¯åŠ¨é˜¶æ®µ

```python
self.browser = await self.playwright.chromium.launch(
    headless=config.PLAYWRIGHT_CONFIG['headless'],
    slow_mo=config.PLAYWRIGHT_CONFIG['slow_mo'],
    args=config.BROWSER_ARGS
)
```

- ä½¿ç”¨`PLAYWRIGHT_CONFIG`ä¸­çš„`headless`å’Œ`slow_mo`é…ç½®
- ä¼ å…¥`BROWSER_ARGS`ä¸­çš„æ‰€æœ‰å¯åŠ¨å‚æ•°
- è¿™æ˜¯åˆ›å»ºä»¿çœŸç¯å¢ƒçš„ç¬¬ä¸€æ­¥ï¼Œå¥ å®šäº†æµè§ˆå™¨çš„åŸºç¡€ç‰¹å¾

### ä¸Šä¸‹æ–‡åˆ›å»ºé˜¶æ®µ

```python
self.context = await self.browser.new_context(
    viewport=config.PLAYWRIGHT_CONFIG['viewport'],
    user_agent=random.choice(config.USER_AGENTS),
    java_script_enabled=config.PLAYWRIGHT_CONFIG['java_script_enabled'],
    ignore_https_errors=config.PLAYWRIGHT_CONFIG['ignore_https_errors'],
    locale='zh-CN',
    timezone_id='Asia/Shanghai',
    geolocation={'latitude': 39.9042, 'longitude': 116.4074},
    permissions=['geolocation']
)
```

- è®¾ç½®è§†å£å¤§å°ã€JavaScriptå¯ç”¨çŠ¶æ€å’ŒHTTPSé”™è¯¯å¿½ç•¥
- é…ç½®åŒºåŸŸè®¾ç½®ä¸ºä¸­æ–‡ï¼ˆ`zh-CN`ï¼‰
- è®¾ç½®æ—¶åŒºä¸ºäºšæ´²/ä¸Šæµ·
- æ¨¡æ‹Ÿåœ°ç†ä½ç½®ä¸ºä¸­å›½åŒ—äº¬
- æˆäºˆåœ°ç†ä½ç½®æƒé™
- è¿™äº›é…ç½®å…±åŒæ„å»ºäº†ä¸€ä¸ªä¸­å›½åœ°åŒºç”¨æˆ·çš„å…¸å‹æµè§ˆå™¨ç¯å¢ƒ

### è¯·æ±‚å¤´è®¾ç½®

```python
await self.context.set_extra_http_headers({
    'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
    'Accept-Encoding': 'gzip, deflate, br',
    'Cache-Control': 'no-cache',
    'Pragma': 'no-cache',
    'sec-ch-ua': '"Chromium";v="120", "Not_A Brand";v="8", "Google Chrome";v="120"',
    'sec-ch-ua-mobile': '?0',
    'sec-ch-ua-platform': '"Windows"',
    'Sec-Fetch-Dest': 'document',
    'Sec-Fetch-Mode': 'navigate',
    'Sec-Fetch-Site': 'none',
    'Sec-Fetch-User': '?1',
    'Upgrade-Insecure-Requests': '1'
})
```

- è®¾ç½®ç¬¦åˆä¸­å›½ç”¨æˆ·ä¹ æƒ¯çš„Accept-Language
- åŒ…å«ç°ä»£æµè§ˆå™¨çš„Client Hintsï¼ˆsec-ch-uaç³»åˆ—ï¼‰
- æ·»åŠ å„ç§å®‰å…¨å’Œå¯¼èˆªç›¸å…³çš„è¯·æ±‚å¤´
- ä½¿HTTPè¯·æ±‚å¤´ä¸çœŸå®æµè§ˆå™¨çš„è¯·æ±‚å¤´é«˜åº¦ç›¸ä¼¼

### åæ£€æµ‹è„šæœ¬æ³¨å…¥

```python
await self.add_stealth_scripts()
```

- è°ƒç”¨`add_stealth_scripts()`æ–¹æ³•ï¼Œæ³¨å…¥æ‰€æœ‰åæ£€æµ‹è„šæœ¬
- è¿™æ˜¯éšè—è‡ªåŠ¨åŒ–ç‰¹å¾çš„å…³é”®æ­¥éª¤
- åœ¨é¡µé¢åˆ›å»ºä¹‹å‰æ³¨å…¥ï¼Œç¡®ä¿è„šæœ¬åœ¨é¡µé¢åŠ è½½æ—¶å°±å·²ç»ç”Ÿæ•ˆ

### é¢„çƒ­å»¶è¿Ÿ

```python
print(f"ğŸŒ¡ï¸ é¢„çƒ­ç­‰å¾… {config.INITIAL_WARMUP_DELAY} ç§’...")
```

- æ·»åŠ 3ç§’çš„é¢„çƒ­å»¶è¿Ÿ
- æ¨¡æ‹Ÿç”¨æˆ·å¯åŠ¨æµè§ˆå™¨åçš„å‡†å¤‡æ—¶é—´
- é¿å…ç«‹å³å¼€å§‹æ“ä½œè€Œæš´éœ²è‡ªåŠ¨åŒ–ç‰¹å¾

**Section sources**
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L517-L579)

## ç»¼åˆä¼ªè£…ç­–ç•¥

æœ¬é¡¹ç›®é€šè¿‡å¤šå±‚é…ç½®å’Œä»£ç å®ç°ï¼Œæ„å»ºäº†ä¸€ä¸ªå…¨é¢çš„æµè§ˆå™¨æŒ‡çº¹ä¼ªè£…ç³»ç»Ÿã€‚

```mermaid
graph TD
A[æµè§ˆå™¨æŒ‡çº¹ä¼ªè£…] --> B[Playwrighté…ç½®]
A --> C[å¯åŠ¨å‚æ•°]
A --> D[JavaScriptè„šæœ¬]
B --> B1[headless]
B --> B2[slow_mo]
B --> B3[viewport]
C --> C1[æ²™ç®±æ§åˆ¶]
C --> C2[èƒŒæ™¯æ´»åŠ¨]
C --> C3[åŠŸèƒ½ç¦ç”¨]
C --> C4[è‡ªåŠ¨åŒ–æ ‡è¯†]
C --> C5[å®‰å…¨ç­–ç•¥]
D --> D1[webdriverå±æ€§]
D --> D2[chromeå¯¹è±¡]
D --> D3[æ’ä»¶åˆ—è¡¨]
D --> D4[è¯­è¨€åå¥½]
E[æœ€ç»ˆæ•ˆæœ] --> F[æ¨¡æ‹ŸçœŸå®ç”¨æˆ·]
E --> G[ç»•è¿‡åçˆ¬æ£€æµ‹]
E --> H[ç¨³å®šæ•°æ®é‡‡é›†]
B --> E
C --> E
D --> E
```

**Diagram sources**
- [config.py](file://config.py#L26-L55)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L517-L614)

### å¤šå±‚æ¬¡é˜²å¾¡ä½“ç³»

1. **è¿›ç¨‹å±‚ä¼ªè£…**ï¼šé€šè¿‡`BROWSER_ARGS`ä¿®æ”¹æµè§ˆå™¨è¿›ç¨‹çš„åº•å±‚è¡Œä¸º
2. **ç¯å¢ƒå±‚ä¼ªè£…**ï¼šé€šè¿‡`PLAYWRIGHT_CONFIG`å’Œä¸Šä¸‹æ–‡é…ç½®æ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„è®¾å¤‡å’Œç½‘ç»œç¯å¢ƒ
3. **JavaScriptå±‚ä¼ªè£…**ï¼šé€šè¿‡æ³¨å…¥è„šæœ¬ä¿®æ”¹æµè§ˆå™¨çš„JavaScript APIï¼Œéšè—è‡ªåŠ¨åŒ–ç‰¹å¾
4. **è¡Œä¸ºå±‚ä¼ªè£…**ï¼šé€šè¿‡`slow_mo`å’Œé¢„çƒ­å»¶è¿Ÿæ¨¡æ‹ŸçœŸå®ç”¨æˆ·çš„æ“ä½œèŠ‚å¥

### åŠ¨æ€ç‰¹å¾è½®æ¢

ç³»ç»Ÿè¿˜å®ç°äº†åŠ¨æ€ç‰¹å¾è½®æ¢æœºåˆ¶ï¼š

- **User-Agentè½®æ¢**ï¼šä»`USER_AGENTS`åˆ—è¡¨ä¸­éšæœºé€‰æ‹©User-Agent
- **è¯·æ±‚å¤´è½®æ¢**ï¼šåœ¨æ›´æ–°æµè§ˆå™¨ä¸Šä¸‹æ–‡æ—¶éšæœºè®¾ç½®é¢å¤–çš„è¯·æ±‚å¤´
- **ä¸Šä¸‹æ–‡è½®æ¢**ï¼šåœ¨è¿ç»­è¯·æ±‚è¾¾åˆ°é™åˆ¶æ—¶ï¼Œåˆ›å»ºæ–°çš„æµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼Œç›¸å½“äºæ›´æ¢èº«ä»½

### å®é™…æ•ˆæœè¯„ä¼°

è¿™ç§ç»¼åˆä¼ªè£…ç­–ç•¥èƒ½å¤Ÿæœ‰æ•ˆåº”å¯¹å¤§å¤šæ•°åŸºäºæµè§ˆå™¨æŒ‡çº¹çš„æ£€æµ‹ï¼š

- **è§„é¿ç®€å•æ£€æµ‹**ï¼šé€šè¿‡éšè—`navigator.webdriver`ç­‰æ˜æ˜¾ç‰¹å¾
- **æ¨¡æ‹ŸçœŸå®ç¯å¢ƒ**ï¼šé€šè¿‡åˆç†çš„åˆ†è¾¨ç‡ã€æ—¶åŒºã€è¯­è¨€ç­‰é…ç½®
- **è¡Œä¸ºæ¨¡æ‹Ÿ**ï¼šé€šè¿‡æ“ä½œå»¶è¿Ÿå’Œé¢„çƒ­æ—¶é—´æ¨¡æ‹Ÿäººç±»è¡Œä¸º
- **é™ä½é£é™©**ï¼šå¤šå±‚ä¼ªè£…ä½¿å¾—å•ä¸€ç‰¹å¾å¼‚å¸¸ä¸ä¼šå¯¼è‡´æ•´ä½“è¢«è¯†åˆ«

é€šè¿‡è¿™ç§å…¨é¢çš„ä¼ªè£…ç­–ç•¥ï¼Œçˆ¬è™«èƒ½å¤Ÿåœ¨ä¸è§¦å‘åçˆ¬è™«æœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œç¨³å®šåœ°é‡‡é›†å“”å“©å“”å“©ç½‘ç«™çš„æ•°æ®ã€‚

**Section sources**
- [config.py](file://config.py#L26-L55)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L517-L614)