# 封面下载功能

<cite>
**本文档引用的文件**   
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py)
- [config.py](file://config.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心功能实现](#核心功能实现)
3. [视频列表获取机制](#视频列表获取机制)
4. [视频信息提取过程](#视频信息提取过程)
5. [文件命名规则](#文件命名规则)
6. [断点续传逻辑](#断点续传逻辑)
7. [配置项说明](#配置项说明)
8. [完整流程示例](#完整流程示例)

## 简介
本项目提供两种模式的封面下载功能：基于requests的API调用模式和基于Playwright的浏览器自动化模式。两种模式均能有效获取B站用户的所有视频封面，并具备完善的反反爬虫策略和错误处理机制。

## 核心功能实现

### 双模式架构
项目采用双模式设计，分别通过 `bilibili_cover_crawler.py` 和 `bilibili_cover_crawler_playwright.py` 两个文件实现：

- **requests模式**：通过直接调用B站API获取数据，轻量级且资源占用低
- **Playwright模式**：通过浏览器自动化加载页面，更真实地模拟用户行为，降低被检测风险

两种模式都实现了完整的封面下载流程，包括用户信息获取、视频列表获取、封面下载和文件保存。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L1-L515)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L1-L2313)

## 视频列表获取机制

### Playwright模式
Playwright模式通过浏览器自动化技术获取用户视频列表，主要流程如下：

```mermaid
graph TD
A[初始化浏览器] --> B[访问用户空间页面]
B --> C[智能滚动加载]
C --> D{是否到达底部?}
D --> |否| C
D --> |是| E[检查分页]
E --> F{是否有下一页?}
F --> |是| G[点击下一页]
G --> C
F --> |否| H[完成收集]
```

**Diagram sources**
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L800-L1599)

该模式通过 `scroll_and_collect_videos` 方法实现滚动加载，使用 `collect_videos_from_current_page` 方法收集当前页面的视频信息，并通过 `check_and_click_next_page` 方法处理分页点击。

**Section sources**
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L800-L1599)

### requests模式
requests模式通过调用B站API分页获取视频数据，主要流程如下：

```mermaid
graph TD
A[构建API请求] --> B[发送请求]
B --> C{响应成功?}
C --> |是| D[解析视频数据]
C --> |否| E[处理错误]
E --> F{是否可重试?}
F --> |是| G[等待后重试]
G --> B
F --> |否| H[返回结果]
D --> I{还有更多页?}
I --> |是| J[增加页码]
J --> A
I --> |否| K[完成获取]
```

**Diagram sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L150-L250)

该模式通过 `get_user_videos` 方法实现分页获取，使用API参数 `pn`（页码）和 `ps`（每页数量）来控制分页。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L150-L250)

## 视频信息提取过程

### 多层级CSS选择器
项目使用多层级CSS选择器来定位视频信息，确保在页面结构变化时仍能正确提取数据。

#### 标题提取
标题提取使用 `TITLE_SELECTORS` 配置项，按优先级顺序尝试不同的选择器：

```mermaid
graph TD
A[尝试.bili-video-card__title] --> B{找到元素?}
B --> |是| C[获取文本内容]
B --> |否| D[尝试.bili-video-card__title a]
D --> E{找到元素?}
E --> |是| F[获取链接文本]
E --> |否| G[尝试.bili-cover-card__title]
G --> H{找到元素?}
H --> |是| I[获取文本内容]
H --> |否| J[尝试通用选择器]
J --> K[返回结果]
```

**Diagram sources**
- [config.py](file://config.py#L230-L245)

#### 封面URL提取
封面URL提取使用 `IMAGE_SELECTORS` 配置项，优先提取高清封面：

```mermaid
graph TD
A[尝试.bili-cover-card__thumbnail img] --> B{找到元素?}
B --> |是| C[获取src属性]
B --> |否| D[尝试.bili-cover-card__thumbnail picture img]
D --> E{找到元素?}
E --> |是| F[获取src属性]
E --> |否| G[尝试通用img选择器]
G --> H{找到元素?}
H --> |是| I[获取src或data-src属性]
H --> |否| J[尝试style背景图片]
J --> K[返回结果]
```

**Diagram sources**
- [config.py](file://config.py#L247-L254)

### 高清封面优先提取
通过 `process_image_url` 方法实现高清封面的优先提取：

```mermaid
graph TD
A[输入图片URL] --> B{包含@符号?}
B --> |是| C[移除@后参数]
B --> |否| D
C --> D[处理相对路径]
D --> E{包含尺寸后缀?}
E --> |是| F[移除尺寸后缀]
E --> |否| G
F --> G[确保扩展名]
G --> H[返回处理后URL]
```

**Diagram sources**
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L1621-L1655)

该方法会移除URL中的参数和尺寸后缀，确保获取到原始高质量图片。

**Section sources**
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L1621-L1655)

## 文件命名规则

### 安全文件名生成
文件命名规则基于BV号和视频标题生成安全文件名，自动处理特殊字符和长度限制。

```mermaid
graph TD
A[获取BV号和标题] --> B[清理文件名]
B --> C[移除特殊字符]
C --> D[移除控制字符]
D --> E{长度超过限制?}
E --> |是| F[截断至限制长度]
E --> |否| G
F --> G[生成文件名]
G --> H[添加扩展名]
H --> I[返回完整文件名]
```

**Diagram sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L154-L163)

### 文件名清理
`sanitize_filename` 方法负责清理文件名中的非法字符：

```python
def sanitize_filename(self, filename):
    """清理文件名，移除不允许的字符"""
    # 移除Windows不允许的字符
    filename = re.sub(r'[<>:"/\\|?*]', '_', filename)
    # 移除控制字符
    filename = re.sub(r'[\x00-\x1f\x7f-\x9f]', '', filename)
    # 限制长度
    if len(filename) > config.MAX_FILENAME_LENGTH:
        filename = filename[:config.MAX_FILENAME_LENGTH]
    return filename.strip()
```

该方法会将Windows系统不允许的字符替换为下划线，并限制文件名长度。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L154-L163)

## 断点续传逻辑

### 文件存在性检查
断点续传逻辑通过检查目标目录中是否存在同名文件来跳过已下载内容。

```mermaid
graph TD
A[生成目标文件路径] --> B{文件已存在?}
B --> |是| C[跳过下载]
B --> |否| D[开始下载]
D --> E[保存文件]
E --> F[更新进度]
```

**Diagram sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L295-L340)

在下载封面前，程序会检查 `save_path.exists()`，如果文件已存在则直接跳过，避免重复下载。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L295-L340)

## 配置项说明

### 核心配置项
项目通过 `config.py` 文件中的配置项支持页面结构变化的适应性：

```mermaid
classDiagram
class Config {
+list VIDEO_SELECTORS
+list TITLE_SELECTORS
+list IMAGE_SELECTORS
+int MAX_FILENAME_LENGTH
+dict PLAYWRIGHT_CONFIG
+dict PAGINATION_CONFIG
}
```

**Diagram sources**
- [config.py](file://config.py#L1-L400)

#### 选择器配置
- **VIDEO_SELECTORS**: 视频元素选择器，按优先级排序
- **TITLE_SELECTORS**: 视频标题选择器，按优先级排序  
- **IMAGE_SELECTORS**: 图片选择器，按优先级排序

#### 浏览器配置
- **PLAYWRIGHT_CONFIG**: Playwright浏览器配置，包括视窗大小、超时等
- **PAGINATION_CONFIG**: 分页操作配置，包括下一页按钮选择器

#### 延迟配置
- **REQUEST_DELAY_MIN/MAX**: 请求间隔最小/最大值
- **DOWNLOAD_DELAY_MIN/MAX**: 下载间隔最小/最大值

**Section sources**
- [config.py](file://config.py#L1-L400)

## 完整流程示例

### 从用户输入到完成下载
从用户输入UID到完成所有封面下载的完整流程如下：

```mermaid
graph TD
A[用户输入UID] --> B[初始化爬虫]
B --> C[获取用户信息]
C --> D[获取视频列表]
D --> E{获取成功?}
E --> |否| F[输出错误]
E --> |是| G[创建保存目录]
G --> H[遍历视频列表]
H --> I[生成文件名]
I --> J{文件已存在?}
J --> |是| K[跳过]
J --> |否| L[下载封面]
L --> M{下载成功?}
M --> |是| N[更新成功计数]
M --> |否| O[添加到失败列表]
N --> P[更新进度]
O --> P
P --> Q{还有视频?}
Q --> |是| H
Q --> |否| R[输出统计结果]
R --> S[保存失败记录]
S --> T[完成]
```

**Diagram sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L1-L515)

该流程展示了从用户输入开始，经过初始化、信息获取、目录创建、文件下载到最终结果输出的完整过程。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L1-L515)