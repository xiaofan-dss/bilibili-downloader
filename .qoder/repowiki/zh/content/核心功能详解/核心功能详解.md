# 核心功能详解

<cite>
**本文档引用的文件**   
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py)
- [config.py](file://config.py)
- [check_ffmpeg.py](file://check_ffmpeg.py)
</cite>

## 目录
1. [封面下载功能](#封面下载功能)
2. [视频下载功能](#视频下载功能)
3. [分页处理机制](#分页处理机制)
4. [反反爬机制](#反反爬机制)
5. [爬虫版本对比](#爬虫版本对比)
6. [面向对象封装与配置管理](#面向对象封装与配置管理)

## 封面下载功能
该功能通过获取用户视频列表并提取每个视频的封面URL（如高清封面`hd_src`）进行批量下载。主爬虫类`BilibiliCoverCrawler`首先通过`get_user_info`方法获取用户基本信息，然后调用`get_user_videos`方法分页获取用户所有视频信息。在获取视频列表时，程序会遍历每一页的视频数据，提取每个视频的BV号、标题和封面图片URL（`pic`字段）。下载时，`download_cover`方法会处理封面图片的下载，支持自动补全URL协议头，并通过`smart_delay`机制控制请求频率。下载前会检查文件是否已存在以避免重复下载，下载完成后会进行结果统计并保存失败记录到`failed_downloads.json`文件中。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L15-L514)

## 视频下载功能
视频下载功能采用分步流程：首先获取视频信息 → 然后分别下载视频流与音频流 → 最后调用FFmpeg合并音视频文件。`BilibiliVideoDownloader`类负责视频下载功能，通过`get_video_info`方法获取视频基本信息，包括CID等关键参数。然后调用`get_play_url`方法获取视频和音频的播放URL。下载过程采用异步方式，`download_segment`方法负责下载视频分段，支持断点续传和错误重试机制。下载完成后，`merge_video_audio`方法会调用FFmpeg将视频和音频文件合并为最终的MP4文件。程序内置了FFmpeg路径查找功能，会按优先级搜索自定义路径、系统PATH和常见安装路径，并在未找到时显示详细的跨平台安装指南。

**Section sources**
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L15-L799)
- [check_ffmpeg.py](file://check_ffmpeg.py#L0-L176)

## 分页处理机制
分页处理通过API分页和DOM遍历两种方式自动获取全部视频数据。在`get_user_videos`方法中，程序通过循环请求用户空间API，每次获取`PAGE_SIZE`（默认30个）视频，直到获取到所有视频数据。程序会检查返回数据中的分页信息，当当前页数乘以每页数量大于等于总视频数时停止请求。在Playwright版本中，程序采用更复杂的分页机制，通过`PAGINATION_CONFIG`配置启用分页点击功能，智能识别并点击"下一页"按钮。程序会等待新页面完全加载，包括JavaScript渲染完成，并通过`get_pagination_info`方法解析分页信息（如"共X页/Y个"）来验证当前页码和总页数。此外，还实现了智能停止功能，当收集数量达到期望值时自动停止，避免不必要的等待。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L15-L514)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L15-L799)

## 反反爬机制
反反爬机制通过多种技术手段规避检测。首先，程序实现了智能延迟控制，`smart_delay`方法根据请求类型（API请求或下载请求）设置不同的延迟范围，并在连续请求达到`MAX_CONSECUTIVE_REQUESTS`（默认30次）后进行长时间休息。其次，程序采用随机化请求头策略，`update_headers`方法会随机选择User-Agent，并根据浏览器类型选择相应的请求头模板，同时随机添加Cache-Control、Pragma等可选头。在Playwright版本中，程序利用Playwright模拟真实浏览器行为，通过`add_stealth_scripts`方法隐藏webdriver属性、模拟真实的chrome对象、插件信息和语言设置。此外，程序还实现了错误处理机制，当检测到反爬错误（如"请求过于频繁"、429状态码）时，会增加冷却时间并更新请求头，同时根据失败次数动态调整延迟时间。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L15-L514)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L15-L799)
- [config.py](file://config.py#L0-L399)

## 爬虫版本对比
项目提供了两种爬虫版本：基于requests的"极限保守版本"和基于Playwright的"推荐版本"。requests版本采用超低速策略，API请求间隔长达15-30秒，适合对速度要求不高但需要绝对稳定的场景。该版本仅使用requests库，资源占用低，兼容性好。Playwright版本则模拟真实浏览器环境，请求间隔较短（3-8秒），成功率更高。它使用真实的Chromium浏览器，支持完整的JavaScript执行和动态内容加载，能够更好地处理复杂的前端渲染。Playwright版本还具备更强大的反反爬能力，如自动更换User-Agent、动态重建浏览器上下文、模拟真实的浏览器会话等。虽然Playwright版本内存占用较高且安装复杂度中等，但对于大用户（1000个视频）的爬取时间从30+小时缩短到8-12小时，效率显著提升。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L15-L514)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L15-L799)
- [README.md](file://README.md#L51-L123)

## 面向对象封装与配置管理
这些功能通过面向对象的方式封装在主爬虫类中，并通过配置文件统一管理行为参数。`BilibiliCoverCrawler`和`PlaywrightBilibiliCrawler`类分别封装了requests版本和Playwright版本的核心功能，采用模块化设计，将用户信息获取、视频列表获取、封面下载、错误处理等功能分解为独立的方法。所有行为参数都集中管理在`config.py`配置文件中，包括请求延迟、重试次数、超时时间、文件路径等。配置文件采用分层结构，为不同功能（如封面爬取、视频下载、FFmpeg处理）提供独立的配置项。这种设计使得程序具有高度的可配置性和可维护性，用户无需修改代码即可通过调整配置文件来改变程序行为。例如，可以通过修改`REQUEST_DELAY_MIN`和`REQUEST_DELAY_MAX`来调整请求间隔，或通过设置`FFMPEG_CONFIG['custom_path']`来指定自定义的FFmpeg路径。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L15-L514)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L15-L799)
- [config.py](file://config.py#L0-L399)