# 错误处理与重试

<cite>
**本文档引用的文件**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py)
- [config.py](file://config.py)
</cite>

## 目录
1. [错误处理机制](#错误处理机制)
2. [重试策略分析](#重试策略分析)
3. [反爬虫识别与冷却策略](#反爬虫识别与冷却策略)
4. [身份切换机制](#身份切换机制)
5. [核心网络请求中的错误处理](#核心网络请求中的错误处理)
6. [两种实现模式对比](#两种实现模式对比)

## 错误处理机制

本文档深入解析项目中的错误处理与自适应重试机制。项目通过 `handle_request_error` 方法实现对反爬虫机制的识别与响应，利用 `failure_count` 计数器实现指数退避重试，并通过 `MAX_RETRIES` 和 `RETRY_BACKOFF` 配置控制重试行为。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L115-L152)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L837-L869)

## 重试策略分析

项目实现了基于指数退避的重试机制，通过 `MAX_RETRIES` 和 `RETRY_BACKOFF` 配置参数控制重试行为。`MAX_RETRIES` 设置最大重试次数为3次，`RETRY_BACKOFF` 设置退避因子为3，使得重试延迟随失败次数呈指数增长。

在 `get_user_info` 和 `get_user_videos` 等网络请求方法中，当捕获到异常时，系统会根据当前重试次数计算延迟时间：`delay = config.RETRY_DELAY * (config.RETRY_BACKOFF ** attempt)`，然后等待相应时间后进行下一次重试。

**Section sources**
- [config.py](file://config.py#L123-L125)
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L165-L204)
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L206-L293)

## 反爬虫识别与冷却策略

`handle_request_error` 方法通过检测错误信息中的反爬关键词来识别反爬虫机制。识别的关键词包括 "请求过于频繁"、"429"、"Too Many Requests"、"rate limit"、"Rate Limited"、"访问频繁"、"Too fast"、"slow down" 和 "限制" 等。

当检测到反爬措施时，系统会执行 `ERROR_COOLDOWN` 冷却策略。冷却时间根据重试次数和连续失败次数动态计算：`cooldown = config.ERROR_COOLDOWN * (attempt + 1) * (1 + self.failure_count * 0.5)`。此外，当失败次数达到3次或以上时，还会增加额外的等待时间。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L115-L152)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L837-L869)

## 身份切换机制

在遭遇错误时，系统会调用特定方法实现"身份"切换，以规避反爬虫检测。在传统爬虫模式中，通过 `update_headers` 方法更换请求头，随机选择不同的 User-Agent 和请求头模板，模拟不同浏览器的访问行为。

在 Playwright 模式中，通过 `update_browser_context` 方法更新浏览器上下文，实现更高级的身份切换。两种模式都通过更换网络请求特征来模拟不同的客户端，提高请求的成功率。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L35-L64)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L837-L869)

## 核心网络请求中的错误处理

在 `get_user_info` 和 `get_user_videos` 等核心网络请求方法中，系统实现了完整的错误处理与重试逻辑。当请求失败时，首先调用 `handle_request_error` 方法检查是否为反爬错误，如果是则执行冷却策略并继续重试。

若不是反爬错误，则根据配置的重试策略进行指数退避重试。每次成功获取数据后，都会重置 `failure_count` 连续失败计数器，确保系统在恢复正常后能够快速恢复正常的请求频率。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L165-L204)
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L206-L293)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L871-L949)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L1789-L1852)

## 两种实现模式对比

项目提供了两种实现模式：传统的 `requests` 模式和基于 `Playwright` 的浏览器模拟模式。在错误处理方面，两种模式都实现了相似的机制，但在具体实现上有所差异。

传统模式通过 `update_headers` 方法更换请求头实现身份切换，而 Playwright 模式通过 `update_browser_context` 方法更新整个浏览器上下文。两种模式都使用 `failure_count` 计数器实现指数退避重试，但 Playwright 模式的冷却策略系数略有不同（0.3 vs 0.5），反映了不同模式下对反爬强度的适应性调整。

**Section sources**
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L115-L152)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L837-L869)