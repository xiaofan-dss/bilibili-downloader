# 更新记录

<cite>
**Referenced Files in This Document**   
- [README.md](file://README.md)
- [config.py](file://config.py)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py)
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py)
- [check_ffmpeg.py](file://check_ffmpeg.py)
</cite>

## Table of Contents
1. [版本演进概览](#版本演进概览)
2. [v2.0.0 (完整版)](#v200-完整版)
3. [v2.0.0 (Playwright版本)](#v200-playwright版本)
4. [v1.2.0 (分页支持版)](#v120-分页支持版)
5. [v1.1.0 (反反爬优化版)](#v110-反反爬优化版)
6. [v1.0.0 (初始版本)](#v100-初始版本)
7. [配置变更与兼容性](#配置变更与兼容性)
8. [升级指南](#升级指南)

## 版本演进概览

本项目自初始版本发布以来，经历了多次重要更新，逐步从一个基础的封面下载工具演变为功能完整的哔哩哔哩视频爬虫系统。版本演进主要围绕**功能扩展**、**性能优化**、**反反爬能力增强**和**用户体验提升**四个核心方向进行。项目现已形成以Playwright版本为主、功能完整的稳定架构。

**Section sources**
- [README.md](file://README.md#L478-L501)

## v2.0.0 (完整版)

### 功能新增
- **视频下载功能**: 新增了完整的视频下载功能，支持通过DASH流分段下载视频和音频，并使用FFmpeg合并为MP4格式。
- **异步处理库**: 引入`aiohttp`和`aiofiles`等异步处理库，提升了网络请求和文件操作的效率。

### 性能优化
- **请求延迟优化**: 在Playwright真实浏览器环境下，将API请求间隔从15-30秒大幅缩短至3-8秒，显著提升了爬取效率。
- **并发控制**: 视频下载模块实现了并发下载控制，最大并发数可配置。

### 缺陷修复
- **字符编码问题**: 修复了在Windows系统下，FFmpeg命令执行时因默认GBK编码导致的输出乱码问题。通过在`subprocess.run`中显式指定`encoding='utf-8'`解决。
- **路径检测失败**: 优化了FFmpeg路径检测逻辑，增加了对项目本地`./bin/ffmpeg.exe`的优先检测。

### 配置项调整
- **FFmpeg配置完善**: `config.py`中的`FFMPEG_CONFIG`对象得到全面增强，支持跨平台路径搜索、自定义路径设置、编码预设、超时控制等。
- **视频下载配置**: 新增`VIDEO_DOWNLOAD_CONFIG`配置对象，用于管理视频下载的各项参数，如质量、格式、并发数等。

**Section sources**
- [README.md](file://README.md#L478-L483)
- [config.py](file://config.py#L300-L399)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L100-L250)

## v2.0.0 (Playwright版本)

### 功能新增
- **Playwright集成**: 重大升级，引入Playwright浏览器自动化技术，通过模拟真实浏览器环境来获取页面内容，从根本上改变了数据获取方式。
- **一键启动脚本**: 提供`start_playwright.bat`和`start_playwright.sh`脚本，简化了依赖安装和启动流程。

### 性能优化
- **成功率提升**: 真实的浏览器环境（Chromium）能够完美执行JavaScript，加载动态内容，大大降低了被反爬虫系统检测和拦截的风险。
- **效率提升**: 由于反爬风险降低，可以安全地将请求间隔缩短，整体爬取速度大幅提升。
- **智能上下文更新**: 实现了`update_browser_context`机制，定期更换浏览器身份，进一步增强反检测能力。

### 缺陷修复
- **页面加载问题**: 通过`wait_for_page_fully_loaded`方法，等待页面的`domcontentloaded`和`networkidle`状态，并额外等待JavaScript执行，解决了因页面未完全加载导致的元素获取失败问题。
- **反检测绕过**: 添加了多个`add_init_script`脚本，用于隐藏`navigator.webdriver`属性、模拟`window.chrome`对象、伪造插件和语言列表，有效绕过基于浏览器指纹的检测。

### 配置项调整
- **Playwright配置**: 在`config.py`中新增`PLAYWRIGHT_CONFIG`和`BROWSER_ARGS`，用于配置浏览器的无头模式、操作延迟、视窗大小、忽略HTTPS错误等。
- **请求头模板**: `BASE_HEADERS_TEMPLATES`配置了更真实的请求头，包括`sec-ch-ua`、`sec-ch-ua-mobile`等现代浏览器特征。

**Section sources**
- [README.md](file://README.md#L484-L491)
- [config.py](file://config.py#L60-L150)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L300-L500)

## v1.2.0 (分页支持版)

### 功能新增
- **分页点击支持**: 新增了对用户视频页面分页功能的支持，程序能够自动检测并点击“下一页”按钮，实现多页视频的连续爬取。
- **数量校验**: 实现了视频数量校验功能，通过解析页面上的分页信息（如“共 X 页 / Y 个”），将实际收集到的视频数量与页面显示的总数进行对比，确保数据完整性。

### 性能优化
- **智能停止**: 引入了`smart_stop`机制，当收集到的视频数量达到页面显示的总数时，程序会自动停止，避免了不必要的等待和请求。

### 缺陷修复
- **用户名选择器更新**: 更新了`USER_NAME_SELECTORS`，增加了对新版页面结构中`.upinfo-detail__top .nickname`等选择器的支持，解决了因页面改版导致的用户名获取失败问题。

### 配置项调整
- **分页配置**: 在`config.py`中新增`PAGINATION_CONFIG`，用于配置分页功能的启用状态、最大页数、点击延迟等。
- **视频数量验证**: 新增`VIDEO_COUNT_VERIFICATION`配置，用于定义分页信息的选择器和正则表达式。

**Section sources**
- [README.md](file://README.md#L492-L495)
- [config.py](file://config.py#L250-L299)

## v1.1.0 (反反爬优化版)

### 性能优化
- **多User-Agent轮换**: 实现了`update_headers`方法，每次请求前随机轮换`USER_AGENTS`列表中的User-Agent，并匹配相应的请求头模板，增加了请求的多样性。
- **智能随机延迟**: `smart_delay`方法根据连续请求次数和失败次数动态调整延迟时间，模拟更真实的人类操作行为。
- **连续请求限制**: 引入`MAX_CONSECUTIVE_REQUESTS`，在连续请求一定次数后，执行`LONG_BREAK_DURATION`的长时间休息，并更新请求头，有效规避了基于频率的反爬策略。
- **指数退避重试**: 重试机制采用指数退避策略，重试间隔随失败次数增加而倍增，避免了在短时间内进行密集重试。

### 缺陷修复
- **反爬检测与处理**: 增强了`handle_request_error`方法，能够识别“请求过于频繁”、“429 Too Many Requests”等反爬错误，并执行相应的冷却和重试策略。

### 配置项调整
- **反反爬配置**: 新增了`REQUEST_DELAY_MIN/MAX`、`DOWNLOAD_DELAY_MIN/MAX`、`MAX_CONSECUTIVE_REQUESTS`、`LONG_BREAK_DURATION`、`ERROR_COOLDOWN`等一系列配置项，使反爬策略更加灵活可调。

**Section sources**
- [README.md](file://README.md#L496-L499)
- [config.py](file://config.py#L150-L249)
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L50-L150)

## v1.0.0 (初始版本)

### 功能新增
- **核心功能发布**: 初始版本发布，实现了基础的用户视频封面批量下载功能。
- **断点续传**: 支持跳过已下载的文件，避免重复下载。
- **错误重试与记录**: 实现了`MAX_RETRIES`次重试机制，并将下载失败的视频记录到`failed_downloads.json`文件中，便于后续排查。

**Section sources**
- [README.md](file://README.md#L500-L501)
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py#L1-L50)

## 配置变更与兼容性

随着版本的迭代，项目的配置文件`config.py`发生了显著变化，但整体上保持了良好的向后兼容性。

- **新增配置项**: 从v1.1.0开始，陆续引入了`PAGINATION_CONFIG`、`PLAYWRIGHT_CONFIG`、`VIDEO_DOWNLOAD_CONFIG`、`FFMPEG_CONFIG`等大型配置对象，用于管理新功能。
- **配置项调整**: `REQUEST_DELAY_MIN/MAX`等反爬配置项的值在v2.0.0版本中因技术栈变更而被调整，Playwright版本的延迟值远小于早期的requests版本。
- **兼容性设计**: 代码中保留了`VIDEO_CARD_SELECTOR`、`USER_NAME_SELECTOR`等旧版选择器作为后备方案，确保在新选择器失效时仍能工作。

**Section sources**
- [config.py](file://config.py#L1-L399)

## 升级指南

建议所有用户升级到最新的v2.0.0完整版，以获得最佳的稳定性和功能体验。

1.  **获取最新代码**: 从仓库拉取最新的代码。
2.  **安装依赖**: 运行`pip install -r requirements.txt`安装Python依赖，然后运行`playwright install chromium`安装Playwright所需的浏览器。
3.  **安装FFmpeg**: 视频下载功能依赖FFmpeg。请根据`check_ffmpeg.py`脚本的提示进行安装，或手动将FFmpeg可执行文件放入`./bin/`目录。
4.  **配置迁移**: 旧版本的配置（如`REQUEST_DELAY_MIN`）在Playwright版本中依然存在，但其作用已减弱。新功能的配置（如视频下载）已在`config.py`中提供默认值，通常无需修改即可使用。
5.  **启动程序**: 推荐使用`start_playwright.bat`（Windows）或`start_playwright.sh`（Linux/Mac）脚本一键启动。

**强烈建议用户关注项目的更新日志**，以便及时了解新功能、性能改进和安全修复，确保爬虫的稳定运行。

**Section sources**
- [README.md](file://README.md#L478-L501)
- [start_playwright.bat](file://start_playwright.bat)
- [start_playwright.sh](file://start_playwright.sh)
- [check_ffmpeg.py](file://check_ffmpeg.py)