# 故障排除

<cite>
**本文档中引用的文件**  
- [EMERGENCY_GUIDE.md](file://EMERGENCY_GUIDE.md)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py)
- [config.py](file://config.py)
- [check_ffmpeg.py](file://check_ffmpeg.py)
</cite>

## 目录
1. [环境检查](#环境检查)
2. [配置验证](#配置验证)
3. [日志分析](#日志分析)
4. [常见问题及解决方案](#常见问题及解决方案)
5. [紧急情况处理](#紧急情况处理)

## 环境检查

在开始排查问题之前，首先需要确认运行环境是否满足基本要求。本程序依赖Python环境、Playwright浏览器以及FFmpeg工具。

### 检查FFmpeg安装状态
FFmpeg是视频合并的关键组件。若未正确安装或路径配置错误，将导致音视频无法合并。

运行`check_ffmpeg.py`脚本进行检测：
```bash
python check_ffmpeg.py
```

该脚本会：
- 检查配置文件中的自定义路径
- 检查系统PATH环境变量
- 检查常见安装路径
- 测试FFmpeg功能是否正常

如果未找到FFmpeg，脚本将显示详细的安装指南，包括Windows、Linux和macOS平台的安装方法。

**Section sources**
- [check_ffmpeg.py](file://check_ffmpeg.py#L1-L176)

### 检查Playwright依赖
Playwright浏览器启动失败通常由以下原因引起：
- Playwright未安装
- Chromium浏览器未下载
- 缺少系统依赖库

可通过`start_playwright.bat`（Windows）或`start_playwright.sh`（Linux/macOS）启动脚本自动安装依赖。这些脚本会检查Python版本、安装所需包并下载Chromium浏览器。

手动安装命令：
```bash
pip install -r requirements.txt
playwright install chromium
```

**Section sources**
- [start_playwright.bat](file://start_playwright.bat#L1-L51)
- [start_playwright.sh](file://start_playwright.sh#L1-L42)

## 配置验证

程序的行为很大程度上取决于`config.py`中的配置参数。正确的配置能有效避免网络连接超时或反爬封锁等问题。

### 调整请求延迟参数
当遇到网络连接超时或被反爬封锁时，建议调整以下参数：

```python
REQUEST_DELAY_MIN = 3  # 最小请求间隔（秒）
REQUEST_DELAY_MAX = 8  # 最大请求间隔（秒）
DOWNLOAD_DELAY_MIN = 2 # 下载间隔最小值（秒）
DOWNLOAD_DELAY_MAX = 5 # 下载间隔最大值（秒）
```

对于频繁被封锁的情况，可进一步增加延迟时间，如将`REQUEST_DELAY_MIN`设为30秒，`REQUEST_DELAY_MAX`设为60秒。

### 配置FFmpeg路径
若FFmpeg未添加到系统PATH，可在`config.py`中指定自定义路径：

```python
FFMPEG_CONFIG = {
    'custom_path': 'C:\\ffmpeg\\bin\\ffmpeg.exe',  # Windows示例
    'enabled': True
}
```

**Section sources**
- [config.py](file://config.py#L1-L399)

## 日志分析

错误日志是定位问题根源的重要依据。程序使用标准日志模块记录运行信息，日志级别可通过`LOG_LEVEL`配置。

### 日志级别设置
```python
LOG_LEVEL = logging.ERROR  # 可选: DEBUG, INFO, WARNING, ERROR, CRITICAL
```

在排查问题时，建议临时将日志级别设为`DEBUG`以获取更详细的信息。

### 常见错误模式识别
通过分析日志中的关键词可快速识别问题类型：

- **反爬封锁**：包含"请求过于频繁"、"429"、"Too Many Requests"、"rate limit"等关键词
- **网络连接问题**：包含"ConnectionError"、"Timeout"、"Network is unreachable"等
- **权限问题**：包含"Permission denied"、"Access is denied"等
- **文件系统问题**：包含"No space left on device"、"Disk quota exceeded"等

程序内置了智能错误处理机制，当检测到反爬关键词时，会自动增加冷却时间并更新请求头。

**Section sources**
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L753-L874)

## 常见问题及解决方案

### FFmpeg相关问题
**问题**：音视频无法合并  
**解决方案**：
1. 运行`check_ffmpeg.py`验证安装
2. 确认FFmpeg路径已正确配置
3. 检查FFmpeg版本兼容性
4. 确保有足够的磁盘空间

### 网络连接问题
**问题**：网络连接超时或被反爬封锁  
**解决方案**：
1. 调整`config.py`中的延迟参数
2. 更换IP地址（重启路由器或使用手机热点）
3. 选择非高峰时段操作（如深夜）
4. 减少并发请求数量

### Playwright浏览器启动失败
**问题**：浏览器无法启动  
**解决方案**：
1. 确认Playwright已正确安装
2. 运行`playwright install chromium`下载浏览器
3. 检查系统是否缺少依赖库（如Linux需安装libglib2.0-0等）
4. 确保有足够的磁盘空间

### 下载内容不完整或遗漏
**问题**：视频或封面下载不完整  
**解决方案**：
1. 检查分页逻辑是否正常工作
2. 验证API稳定性，必要时增加重试次数
3. 确认网络连接稳定
4. 检查目标目录是否有写入权限

### 权限不足导致写入失败
**问题**：无法保存文件  
**解决方案**：
1. 检查目标目录的写入权限
2. 尝试以管理员身份运行程序
3. 更改输出目录到有写权限的路径
4. 确保磁盘空间充足

**Section sources**
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py#L753-L874)
- [config.py](file://config.py#L1-L399)

## 紧急情况处理

当遇到大规模封禁或其他紧急情况时，应立即采取以下措施。

### 大规模封禁应对策略
根据`EMERGENCY_GUIDE.md`中的指导，当IP被标记或请求被频繁拦截时：

1. **立即停止程序**，等待30-60分钟冷却
2. **更换网络环境**，使用手机热点或VPN
3. **选择合适时间段**，避开高峰期（晚上8-11点）
4. **调整配置参数**，大幅增加请求延迟和冷却时间

```python
REQUEST_DELAY_MIN = 30      # 增加到30秒
REQUEST_DELAY_MAX = 60      # 增加到60秒
ERROR_COOLDOWN = 1200       # 增加到20分钟
INITIAL_WARMUP_DELAY = 120  # 增加到2分钟
```

### 故障报告模板
寻求技术支持时，请提供以下信息：
```
问题描述：[具体问题]
错误信息：[复制具体的错误提示]
使用时间：[年-月-日 时:分]
网络环境：[家庭WiFi/公司网络/手机热点/其他]
尝试的解决方法：[列出已尝试的方法]
用户UID：[你要爬取的用户ID]
系统环境：[Windows/Mac/Linux + 版本]
```

**Section sources**
- [EMERGENCY_GUIDE.md](file://EMERGENCY_GUIDE.md#L1-L142)