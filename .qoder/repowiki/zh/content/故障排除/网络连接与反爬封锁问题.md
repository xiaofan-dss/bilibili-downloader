# 网络连接与反爬封锁问题

<cite>
**Referenced Files in This Document**   
- [EMERGENCY_GUIDE.md](file://EMERGENCY_GUIDE.md)
- [config.py](file://config.py)
- [bilibili_cover_crawler.py](file://bilibili_cover_crawler.py)
- [bilibili_cover_crawler_playwright.py](file://bilibili_cover_crawler_playwright.py)
- [README.md](file://README.md)
</cite>

## 目录
1. [问题分析](#问题分析)
2. [立即应对措施](#立即应对措施)
3. [配置参数优化](#配置参数优化)
4. [网络连通性自检](#网络连通性自检)
5. [执行策略建议](#执行策略建议)

## 问题分析

当爬虫程序在"获取用户信息"阶段就失败时，通常由以下原因导致：

1. **IP被封禁**: 当前IP地址已被哔哩哔哩的反爬虫系统标记
2. **请求频率过高**: 近期请求过于频繁，触发了临时限制
3. **网络环境不稳定**: 当前网络连接质量不佳或存在防火墙限制
4. **高峰时段限制**: 在用户活跃高峰期（如晚上8-11点），反爬虫策略更加严格

这些因素可能导致HTTP 429（请求过于频繁）或其他访问限制错误，影响爬取任务的正常执行。

**Section sources**
- [EMERGENCY_GUIDE.md](file://EMERGENCY_GUIDE.md#L1-L60)
- [README.md](file://README.md#L478-L501)

## 立即应对措施

当遇到爬取失败时，应立即采取以下冷却和恢复措施：

### 等待冷却
停止程序运行，等待30-60分钟后再尝试。在此期间避免进行任何相关的网络请求，让IP地址的限制自然解除。

### 更换网络环境
通过更换网络连接来获取新的IP地址：
- 使用手机热点替代当前WiFi
- 重启路由器以获取新的公网IP
- 切换到其他可用的网络连接
- 在允许的情况下使用VPN服务

### 选择合适时间段
避开网络使用高峰期，选择以下推荐时段操作：
- 深夜：00:00-06:00
- 早晨：06:00-09:00  
- 下午：14:00-17:00

这些时段网络负载较小，反爬虫系统相对宽松，成功率更高。

**Section sources**
- [EMERGENCY_GUIDE.md](file://EMERGENCY_GUIDE.md#L60-L115)

## 配置参数优化

通过调整`config.py`中的相关参数，可以有效降低请求频率，增强反反爬能力。

### 请求延迟配置
调整`REQUEST_DELAY_MIN`和`REQUEST_DELAY_MAX`参数，增加请求间隔时间：

```python
# 增加延迟时间（单位：秒）
REQUEST_DELAY_MIN = 30  # 最小延迟
REQUEST_DELAY_MAX = 60  # 最大延迟
```

### 错误冷却配置
当发生错误时，通过`ERROR_COOLDOWN`参数设置更长的冷却时间：

```python
# 增加错误后冷却时间（单位：秒）
ERROR_COOLDOWN = 1200  # 20分钟
```

### 预热与首次请求延迟
优化预热和首次请求的延迟设置，避免初始请求过于突兀：

```python
# 增加预热时间（单位：秒）
INITIAL_WARMUP_DELAY = 120  # 2分钟

# 增加首次请求延迟（单位：秒）
FIRST_REQUEST_DELAY = 60  # 1分钟
```

这些参数的调整能够显著降低被检测为自动化脚本的风险，提高爬取成功率。

**Section sources**
- [EMERGENCY_GUIDE.md](file://EMERGENCY_GUIDE.md#L100-L115)
- [config.py](file://config.py#L200-L220)

## 网络连通性自检

在重新运行爬虫程序前，建议进行网络连通性检查，以确定问题是否源于本地网络。

### 连通性检测命令
使用以下命令检查与哔哩哔哩服务器的连接状态：

```bash
# 检查是否能正常访问哔哩哔哩
ping www.bilibili.com

# 检查DNS解析是否正常
nslookup api.bilibili.com
```

这些命令可以帮助判断：
- 本地网络是否能够连接到目标服务器
- DNS解析是否存在故障
- 网络延迟是否在正常范围内

如果这些命令执行失败或响应异常，说明问题可能出在本地网络环境，需要先解决网络连接问题。

**Section sources**
- [EMERGENCY_GUIDE.md](file://EMERGENCY_GUIDE.md#L115-L125)

## 执行策略建议

为提高爬取成功率，建议遵循以下执行策略：

### 避免连续高频请求
不要在短时间内连续运行爬虫程序，每次使用后应间隔至少6-12小时，大用户建议间隔24-48小时。

### 分时段分批次执行
对于包含大量视频的用户，建议分时段、分批次执行任务：
- 将大任务拆分为多个小任务
- 在不同时间段分别执行
- 每次执行后给予足够的冷却时间

### 轮换网络环境
不要总是使用同一个网络环境，定期轮换不同的网络连接可以降低被持续监控的风险。

### 监控使用频率
记录每次使用的时间和结果，如果连续多次失败，应停止使用并延长冷却时间。

通过遵循这些策略，可以显著提高爬取成功率，同时减少对目标服务器的压力。

**Section sources**
- [EMERGENCY_GUIDE.md](file://EMERGENCY_GUIDE.md#L125-L142)